#!/usr/bin/env bash
set -u

# Allowed conventional commit types
TYPE_GROUP='feat|fix|hotfix|chore|refactor|docs|style|test|ci|build|perf|revert'

# Conventional commit:
#   type: message
#   type(scope): message
#   type!: message
#   type(scope)!: message
CONV_PATTERN="^(${TYPE_GROUP})(\\([^)]+\\))?(!)?: .+"

# Jira + conventional:
#   [PROJ-123] type: message
#   [PROJ-123] type(scope): message
#   [PROJ-123] type!: message
#   [PROJ-123] type(scope)!: message
JIRA_PATTERN="^\\[[A-Z][A-Z0-9]+-[0-9]+\\] (${TYPE_GROUP})(\\([^)]+\\))?(!)?: .+"

MSG_FILE="$1"
FIRST_LINE="$(head -n1 "$MSG_FILE")"

# If it matches either pattern, we're good
if [[ "$FIRST_LINE" =~ $CONV_PATTERN || "$FIRST_LINE" =~ $JIRA_PATTERN ]]; then
  exit 0
fi

echo
echo "Bad commit message."
echo "First line must be either a conventional commit or Jira+conventional."
echo
echo "Examples:"
echo "  feat: add login flow"
echo "  fix(auth): handle expired token"
echo "  hotfix!: emergency fix in prod"
echo "  [PROJ-123] feat: implement checkout"
echo "  [API-42] fix(auth): handle expired token"
echo
echo "Got:"
echo "  $FIRST_LINE"
echo

# Ask on /dev/tty so we don’t steal git’s stdin
while read -r -p "Do you really want to commit with that message? (y/n) " yn </dev/tty; do
  case "$yn" in
    [Yy])
      echo "Committing with non-standard message."
      exit 0
      ;;
    [Nn])
      echo "Commit aborted."
      exit 1
      ;;
    *)
      echo "Please answer y (yes) or n (no)."
      ;;
  esac
done
