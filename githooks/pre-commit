#!/usr/bin/env bash
set -u

# Comma- or space-separated list of protected branches.
# Default: master and main
: "${GITHOOKS_PROTECTED_BRANCHES:=master main}"

BRANCH="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || true)"
BRANCH="${BRANCH:-}"

if [[ -z "$BRANCH" || "$BRANCH" == "HEAD" ]]; then
  exit 0
fi

IFS=' ,:' read -r -a PROTECTED <<<"$GITHOOKS_PROTECTED_BRANCHES"

is_protected=0
for b in "${PROTECTED[@]}"; do
  [[ "$BRANCH" == "$b" ]] && is_protected=1 && break
done

if [[ $is_protected -eq 1 ]]; then
    echo "You are about to commit directly to a protected branch: '$BRANCH'."

    while read -r -p "Do you really want to commit to $BRANCH? (y/n) " yn </dev/tty; do
    case "$yn" in
        [Yy])
        echo "Committing to $BRANCH."
        break
        ;;
        [Nn])
        echo "Commit aborted."
        exit 1
        ;;
        *)
        echo "Please answer y (yes) or n (no)."
        ;;
    esac
    done
fi

STAGED_GO=$(git diff --cached --name-only -- '*.go')
if [[ -n "$STAGED_GO" ]]; then
  echo "[pre-commit] gofumpt / goimports on staged Go filesâ€¦"
  echo "$STAGED_GO" | xargs -r gofumpt -w
  echo "$STAGED_GO" | xargs -r goimports -w

  # Re-stage files after formatting
  echo "$STAGED_GO" | xargs -r git add

  FILES_WITH_PRINTLN="$(git grep --cached -l -- 'fmt\.Println' -- '*.go' || true)"
  if [[ -n "$FILES_WITH_PRINTLN" ]]; then
     echo "Found fmt.Println in staged Go files:"
     echo "$FILES_WITH_PRINTLN"

    while read -r -p "Do you really want to commit? (y/n) " yn </dev/tty; do
    case "$yn" in
        [Yy])
        echo "Committing to $BRANCH."
        break
        ;;
        [Nn])
        echo "Commit aborted."
        exit 1
        ;;
        *)
        echo "Please answer y (yes) or n (no)."
        ;;
    esac
    done
  fi
fi
