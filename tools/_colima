#compdef colima-tools

# Complete Colima profile names
_colima_profiles() {
  local -a profiles
  local json
  if json=$(colima list --json 2>/dev/null); then
    profiles=(${(f)"$(echo $json | jq -r '.[].name' 2>/dev/null)"})
  fi
  (( ${#profiles[@]} )) || profiles=(default)
  _describe 'profile' profiles
}

# Complete snapshot names
_colima_snapshots() {
  local -a snaps
  snaps=(${(f)"$(colima snapshot list 2>/dev/null | awk 'NR>1{print $1}')"}) # skip header
  _describe 'snapshot' snaps
}

_arguments -C \
  '1:subcommand:(start stop restart status logs prune nuke ssh images ports snap_save snap_load)' \
  '*::args:->args'

case $state in
  args)
    case $words[2] in
      snap_save)
        _arguments '1:snapshot name:'
        ;;
      snap_load)
        _arguments '1:snapshot name:_colima_snapshots'
        ;;
      start|stop|restart|status|logs|prune|nuke|ssh|images|ports)
        _message 'no arguments; optionally set COLIMA_PROFILE=<profile>'
        ;;
      *)
        _message 'select a subcommand'
        ;;
    esac
    ;;
esac
